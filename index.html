<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuditorIA 360</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: GMC360 2025 -->
    <!-- Application Structure Plan: Se ha dise√±ado una SPA con una estructura de tres pesta√±as tem√°ticas para separar claramente los casos de uso: 1) Gu√≠a Estrat√©gica (consulta de informaci√≥n), 2) Asistente de Hallazgos (herramienta de trabajo para auditores) y 3) Simulador de Examen (herramienta de estudio). Esta arquitectura modular permite al usuario enfocarse en una tarea a la vez, mejorando la usabilidad. La navegaci√≥n es simple y directa, facilitando el acceso a cada herramienta sin salir de la p√°gina. -->
    <!-- Visualization & Content Choices: La "Gu√≠a Estrat√©gica" utiliza texto estructurado con HTML y Tailwind para presentar el an√°lisis ejecutivo. El objetivo es INFORMAR. Los m√≥dulos interactivos usar√°n men√∫s desplegables (select) para la selecci√≥n y mostrar√°n los resultados generados por la IA en bloques de texto din√°micos. El objetivo es ORGANIZAR la auditor√≠a y PROBAR el conocimiento. Las visualizaciones se basan en texto din√°mico generado por la IA, evitando gr√°ficos complejos para mantener la claridad. Las interacciones se manejan con JavaScript y llamadas a una API externa (funci√≥n Netlify). -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .bg-custom-purple { background-color: #8a62c4; }
        .bg-custom-offwhite { background-color: #f6fff8; }
        .text-custom-purple { color: #8a62c4; }
        .text-custom-gray { color: #4d4d4d; }
        .text-custom-dark-gray { color: #343a40; }
        .hover\:bg-custom-purple-dark:hover { background-color: #734eae; }
        .focus\:ring-custom-purple:focus { --tw-ring-color: rgba(138, 98, 196, 1); }
        .module-btn.active { background-color: #ff8361; color: #ffffff; font-weight: 600; }
        .module-btn { background-color: #e9ecef; color: #495057; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #8a62c4; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-custom-offwhite p-4 md:p-8">

    <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-custom-purple">AuditorIA 360</h1>
        <p class="mt-2 text-lg text-custom-gray">Asistente Interactivo para Auditores de PLD/FT</p>
    </header>

    <main class="max-w-4xl mx-auto">
        <div class="flex flex-col sm:flex-row justify-center gap-2 mb-8 p-1 bg-gray-200 rounded-full">
            <button id="btn-guia" class="module-btn w-full text-center py-2 px-4 rounded-full transition-all duration-300">üó∫Ô∏è Gu√≠a Estrat√©gica</button>
            <button id="btn-asistente" class="module-btn w-full text-center py-2 px-4 rounded-full transition-all duration-300">üîç Asistente de Hallazgos</button>
            <button id="btn-simulador" class="module-btn w-full text-center py-2 px-4 rounded-full transition-all duration-300">üìù Simulador de Examen</button>
        </div>

        <div id="module-guia" class="module-content fade-in">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-6 text-custom-dark-gray border-b pb-4">An√°lisis Ejecutivo: Lineamientos de Auditor√≠a PLD/FT</h2>
                <div class="space-y-6 text-custom-gray">
                    <section>
                        <h3 class="font-bold text-xl text-gray-800 mb-2">Introducci√≥n: La Auditor√≠a como "Tercera L√≠nea de Defensa"</h3>
                        <p>Siguiendo las mejores pr√°cticas internacionales (GAFI y Comit√© de Basilea), la funci√≥n de auditor√≠a se considera la <strong>tercera l√≠nea de defensa</strong> en la lucha contra el Lavado de Dinero. Su objetivo no es solo un requisito regulatorio, sino una evaluaci√≥n cr√≠tica de la <strong>eficacia</strong> de todo el r√©gimen preventivo de una entidad financiera. Los Lineamientos emitidos por la CNBV el 18 de octubre de 2021 establecen el est√°ndar para este proceso.</p>
                    </section>
                    <section>
                        <h3 class="font-bold text-xl text-gray-800 mb-2">Apartado B: El Auditor - Qui√©n Puede y Qui√©n NO Puede Auditar</h3>
                        <p>Esta secci√≥n define el perfil del responsable de la auditor√≠a, enfoc√°ndose en su capacidad y, sobre todo, en su independencia.</p>
                        <div class="mt-4 p-4 border-l-4 border-custom-purple bg-purple-50 rounded-r-lg">
                            <h4 class="font-semibold text-lg text-custom-purple mb-2">Requisitos Clave del Auditor:</h4>
                             <ul class="list-disc list-inside space-y-1">
                                <li><strong>Certificado Vigente:</strong> Indispensable contar con la certificaci√≥n de la CNBV en materia de PLD/FT.</li>
                                <li><strong>Experiencia Comprobable:</strong> M√≠nimo 3 a√±os de experiencia con licenciatura, o 5 a√±os sin ella.</li>
                             </ul>
                        </div>
                        <div class="mt-4 p-4 border-l-4 border-red-500 bg-red-50 rounded-r-lg">
                             <h4 class="font-semibold text-lg text-red-700 mb-2">Los 7 "Pecados" del Auditor (Conflictos de Inter√©s):</h4>
                             <ul class="list-disc list-inside space-y-1">
                                <li><strong>Ser o haber sido</strong> consejero, directivo, OC o empleado del Sujeto Supervisado en el √∫ltimo a√±o.</li>
                                <li>Formar parte de la <strong>estructura accionaria</strong>.</li>
                                <li>Tener <strong>litigio pendiente</strong> con la entidad.</li>
                                <li>Estar <strong>inhabilitado</strong> o haber sido sentenciado por delitos patrimoniales.</li>
                             </ul>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <div id="module-asistente" class="module-content hidden fade-in">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-custom-dark-gray">1. Seleccione la Obligaci√≥n a Revisar</h2>
                <select id="obligation-select" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-custom-purple transition"></select>
                <div id="selected-obligation-text" class="mt-4 p-4 bg-gray-100 rounded-md text-gray-700 min-h-[50px]">Seleccione una obligaci√≥n del men√∫ para ver su descripci√≥n.</div>
                <button id="generate-guide-btn" class="mt-6 w-full bg-custom-purple text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-custom-purple-dark transition-all duration-300 flex items-center justify-center text-lg disabled:opacity-50" disabled>‚ú® Generar Gu√≠a de Auditor√≠a con IA</button>
                <div id="loader-asistente" class="hidden mt-6 flex flex-col items-center justify-center text-center"><div class="spinner"></div><p class="text-custom-gray mt-2">Analizando... La IA est√° preparando su gu√≠a de auditor√≠a.</p></div>
                <div id="asistente-result" class="mt-6"></div>
            </div>
        </div>

        <div id="module-simulador" class="module-content hidden fade-in">
             <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-custom-dark-gray">1. Seleccione un Tema para Practicar</h2>
                 <select id="topic-select" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-custom-purple transition"></select>
                <button id="generate-question-btn" class="mt-6 w-full bg-custom-purple text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-custom-purple-dark transition-all duration-300 flex items-center justify-center text-lg disabled:opacity-50" disabled>üß† Generar Pregunta de Caso Pr√°ctico</button>
                <div id="loader-simulador" class="hidden mt-6 flex flex-col items-center justify-center text-center"><div class="spinner"></div><p class="text-custom-gray mt-2">Creando un nuevo caso de estudio...</p></div>
                <div id="simulador-result" class="mt-6"></div>
            </div>
        </div>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const obligationsData = [
                { id: 3, categoria: "1. IDENTIFICACI√ìN", obligacion: "a) Cuenta con un Manual de Cumplimiento con los criterios, medidas y procedimientos internos para la debida Identificaci√≥n del Cliente o Usuario.", fuente_lineamiento: "Lineamiento Octavo, A, I, a)", fuente_disposicion_bancos: "Disposici√≥n 64¬™" },
                { id: 9, categoria: "1. IDENTIFICACI√ìN", obligacion: "b) Identifica al Cliente o Usuario de conformidad con el perfil, caracter√≠sticas y tipo de Cliente o Usuario.", fuente_lineamiento: "Lineamiento Octavo, A, I, b)", fuente_disposicion_bancos: "Disposici√≥n 4¬™" },
                { id: 18, categoria: "2. METODOLOG√çA", obligacion: "a) Estableci√≥ procesos para la identificaci√≥n, medici√≥n y mitigaci√≥n de los Riesgos.", fuente_lineamiento: "Lineamiento Octavo, A, II, a)", fuente_disposicion_bancos: "Disposici√≥n 21¬™-1" },
                { id: 19, categoria: "2. METODOLOG√çA", obligacion: "b) Dise√±√≥ e implement√≥ una metodolog√≠a para la evaluaci√≥n de Riesgos.", fuente_lineamiento: "Lineamiento Octavo, A, II, b)", fuente_disposicion_bancos: "Disposici√≥n 21¬™-1" },
                { id: 30, categoria: "3. CONOCIMIENTO", obligacion: "c) Cuenta con un modelo de evaluaci√≥n de Riesgos para determinar el Grado de Riesgo de los Clientes.", fuente_lineamiento: "Lineamiento Octavo, A, III, c)", fuente_disposicion_bancos: "Disposici√≥n 25¬™ Bis" },
                { id: 32, categoria: "3. CONOCIMIENTO", obligacion: "d) Cuenta con un sistema de alertas para detectar cambios en el comportamiento transaccional.", fuente_lineamiento: "Lineamiento Octavo, A, III, d)", fuente_disposicion_bancos: "Disposici√≥n 25¬™ Qu√°ter" },
                { id: 44, categoria: "4. REPORTES", obligacion: "a) Present√≥ en tiempo y forma, los reportes de Operaciones Relevantes.", fuente_lineamiento: "Lineamiento Octavo, A, IV, a)", fuente_disposicion_bancos: "Disposici√≥n 34¬™" },
                { id: 45, categoria: "4. REPORTES", obligacion: "b) Present√≥ en tiempo y forma los reportes de Operaciones Inusuales.", fuente_lineamiento: "Lineamiento Octavo, A, IV, b)", fuente_disposicion_bancos: "Disposici√≥n 37¬™" },
                { id: 48, categoria: "4. REPORTES", obligacion: "d) Present√≥ en tiempo y forma los reportes de Operaciones Internas Preocupantes.", fuente_lineamiento: "Lineamiento Octavo, A, IV, d)", fuente_disposicion_bancos: "Disposici√≥n 42¬™" },
                { id: 54, categoria: "5. ESTRUCTURAS INTERNAS", obligacion: "a) Integr√≥ el Comit√© de Comunicaci√≥n y Control de conformidad con las Disposiciones.", fuente_lineamiento: "Lineamiento Octavo, A, V, a)", fuente_disposicion_bancos: "Disposici√≥n 43¬™" },
            ];

            const buttons = [ document.getElementById('btn-guia'), document.getElementById('btn-asistente'), document.getElementById('btn-simulador') ];
            const modules = [ document.getElementById('module-guia'), document.getElementById('module-asistente'), document.getElementById('module-simulador') ];
            const loaders = { asistente: document.getElementById('loader-asistente'), simulador: document.getElementById('loader-simulador') };
            const results = { asistente: document.getElementById('asistente-result'), simulador: document.getElementById('simulador-result') };
            const obligationSelect = document.getElementById('obligation-select');
            const topicSelect = document.getElementById('topic-select');
            const selectedObligationText = document.getElementById('selected-obligation-text');
            const generateGuideBtn = document.getElementById('generate-guide-btn');
            const generateQuestionBtn = document.getElementById('generate-question-btn');

            function setupTabs() {
                buttons[0].classList.add('active');
                modules[0].classList.remove('hidden');
                modules[1].classList.add('hidden');
                modules[2].classList.add('hidden');
                
                buttons.forEach((button, index) => {
                    button.addEventListener('click', () => {
                        buttons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        modules.forEach(module => module.classList.add('hidden'));
                        modules[index].classList.remove('hidden');
                    });
                });
            }

            function populateSelects() {
                const categories = [...new Set(obligationsData.map(item => item.categoria))];
                obligationSelect.innerHTML = '<option value="" disabled selected>-- Elija una obligaci√≥n --</option>';
                categories.forEach(category => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category;
                    obligationsData.filter(item => item.categoria === category).forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.obligacion.substring(0, 80) + '...';
                        optgroup.appendChild(option);
                    });
                    obligationSelect.appendChild(optgroup);
                });
                topicSelect.innerHTML = '<option value="" disabled selected>-- Elija un tema --</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    topicSelect.appendChild(option);
                });
            }
            
            async function handleApiCall(module, payload) {
                const btn = module === 'asistente' ? generateGuideBtn : generateQuestionBtn;
                loaders[module].classList.remove('hidden');
                results[module].innerHTML = '';
                btn.disabled = true;

                try {
                    const response = await fetch('/.netlify/functions/geminiProxy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Error de la API: ${response.status} - ${errorText}`);
                    }
                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                       throw new Error("La respuesta de la API no tiene el formato esperado.");
                    }
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const data = JSON.parse(jsonText);
                    if (module === 'asistente') renderAsistenteResult(data);
                    if (module === 'simulador') renderSimuladorResult(data);
                } catch (error) {
                    console.error("Error:", error);
                    results[module].innerHTML = `<p class="text-red-600 p-4 bg-red-100 rounded-md">Ocurri√≥ un error al contactar a la IA. Revisa la consola para m√°s detalles. (Nota: esta funci√≥n requiere despliegue en Netlify para operar).</p>`;
                } finally {
                    loaders[module].classList.add('hidden');
                    btn.disabled = false;
                }
            }
            
            function renderAsistenteResult(data) {
                const { pruebas_sugeridas = [], posibles_hallazgos = [], recomendaciones_mejora = [] } = data;
                results.asistente.innerHTML = `<div class="border border-gray-200 rounded-lg p-4 fade-in space-y-4"><div><h3 class="text-lg font-semibold mb-2 text-custom-purple">‚ñ∂Ô∏è Pruebas de Auditor√≠a Sugeridas</h3><ul class="list-disc list-inside space-y-1 text-custom-gray">${pruebas_sugeridas.map(item => `<li>${item}</li>`).join('')}</ul></div><div><h3 class="text-lg font-semibold mb-2 text-custom-purple">‚ö†Ô∏è Posibles Hallazgos</h3><ul class="list-disc list-inside space-y-1 text-custom-gray">${posibles_hallazgos.map(item => `<li>${item}</li>`).join('')}</ul></div><div><h3 class="text-lg font-semibold mb-2 text-custom-purple">üí° Recomendaciones de Mejora</h3><ul class="list-disc list-inside space-y-1 text-custom-gray">${recomendaciones_mejora.map(item => `<li>${item}</li>`).join('')}</ul></div></div>`;
            }

            function renderSimuladorResult(data) {
                const { caso_practico, pregunta, opciones, respuesta_correcta, justificacion } = data;
                let optionsHtml = Object.keys(opciones).map(key => `<label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="radio" name="quiz-option" value="${key}" class="form-radio text-purple-600"><span class="ml-3 text-gray-700"><strong>${key})</strong> ${opciones[key]}</span></label>`).join('');
                results.simulador.innerHTML = `<div class="border border-gray-200 rounded-lg p-4 fade-in"><h3 class="text-lg font-semibold mb-2 text-gray-800">Caso Pr√°ctico:</h3><p class="text-custom-gray mb-4">${caso_practico}</p><p class="text-custom-gray font-semibold mb-4">${pregunta}</p><div id="quiz-options" class="space-y-3">${optionsHtml}</div><button id="eval-btn" class="mt-4 bg-gray-700 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-800">Evaluar Respuesta</button><div id="feedback" class="mt-4 p-3 rounded-r-lg hidden"></div></div>`;
                document.getElementById('eval-btn').addEventListener('click', () => {
                    const selectedOption = document.querySelector('input[name="quiz-option"]:checked');
                    const feedbackDiv = document.getElementById('feedback');
                    if (selectedOption) {
                        feedbackDiv.classList.remove('hidden');
                        if(selectedOption.value === respuesta_correcta) {
                            feedbackDiv.className = 'mt-4 p-3 bg-green-100 text-green-800 border-l-4 border-green-500 rounded-r-lg fade-in';
                            feedbackDiv.innerHTML = `<h4 class="font-bold">¬°Correcto!</h4><p>${justificacion}</p>`;
                        } else {
                            feedbackDiv.className = 'mt-4 p-3 bg-red-100 text-red-800 border-l-4 border-red-500 rounded-r-lg fade-in';
                            feedbackDiv.innerHTML = `<h4 class="font-bold">Incorrecto.</h4><p>La respuesta correcta es la <strong>${respuesta_correcta}</strong>. ${justificacion}</p>`;
                        }
                    } else { alert('Por favor, selecciona una opci√≥n.'); }
                });
            }

            obligationSelect.addEventListener('change', () => {
                const selected = obligationsData.find(item => item.id == obligationSelect.value);
                selectedObligationText.textContent = selected ? selected.obligacion : '';
                generateGuideBtn.disabled = !selected;
            });

            topicSelect.addEventListener('change', () => {
                generateQuestionBtn.disabled = !topicSelect.value;
            });
            
            generateGuideBtn.addEventListener('click', () => {
                const selectedId = obligationSelect.value;
                if (!selectedId) { alert('Por favor, seleccione una obligaci√≥n.'); return; }
                const obligation = obligationsData.find(item => item.id == selectedId);
                const prompt = `Act√∫a como un auditor experto en PLD/FT en M√©xico. Basado en la obligaci√≥n de auditor√≠a: '${obligation.obligacion}', fundamentada en '${obligation.fuente_lineamiento}' y que revisa el cumplimiento de la '${obligation.fuente_disposicion_bancos}'. Genera una gu√≠a pr√°ctica inspirada en la estructura de un dictamen real. Responde √∫nicamente con un objeto JSON v√°lido con las claves "pruebas_sugeridas", "posibles_hallazgos", y "recomendaciones_mejora", cada una con un array de 3 a 4 strings concisos y profesionales.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                handleApiCall('asistente', payload);
            });

            generateQuestionBtn.addEventListener('click', () => {
                const selectedTopic = topicSelect.value;
                if (!selectedTopic) { alert('Por favor, seleccione un tema.'); return; }
                const prompt = `Act√∫a como un creador de ex√°menes para la certificaci√≥n de auditores PLD/FT en M√©xico. Genera un caso pr√°ctico y una pregunta de opci√≥n m√∫ltiple sobre el tema "${selectedTopic}". Responde √∫nicamente con un objeto JSON v√°lido con las claves "caso_practico", "pregunta", "opciones" (un objeto con A,B,C,D), "respuesta_correcta" (la letra), y "justificacion" (explicando la respuesta y citando la normativa de forma concisa).`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                handleApiCall('simulador', payload);
            });

            setupTabs();
            populateSelects();
        });
    </script>
</body>
</html>

